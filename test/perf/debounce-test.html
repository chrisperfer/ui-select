<!DOCTYPE html>
<html ng-app="debounceTest">
<head>
    <script src="../../node_modules/angular/angular.js"></script>
    <script src="../../node_modules/angular-sanitize/angular-sanitize.js"></script>
    <script src="../../dist/select.js"></script>
    <link rel="stylesheet" href="../../dist/select.css">
    <style>
        .container { padding: 20px; }
        .stats { margin: 20px 0; padding: 10px; background: #f0f0f0; }
        .metric { margin: 5px 0; }
    </style>
</head>
<body ng-controller="TestController">
    <div class="container">
        <h2>Debounce Performance Test</h2>

        <h3>No Debounce (0ms)</h3>
        <ui-select ng-model="selected1" search-debounce="0">
            <ui-select-match>{{$select.selected.name}}</ui-select-match>
            <ui-select-choices repeat="item in items | filter: $select.search">
                <div ng-bind-html="item.name | highlight: $select.search"></div>
            </ui-select-choices>
        </ui-select>

        <h3>Default Debounce (200ms)</h3>
        <ui-select ng-model="selected2">
            <ui-select-match>{{$select.selected.name}}</ui-select-match>
            <ui-select-choices repeat="item in items | filter: $select.search">
                <div ng-bind-html="item.name | highlight: $select.search"></div>
            </ui-select-choices>
        </ui-select>

        <div class="stats">
            <h3>Performance Metrics</h3>
            <div class="metric">No Debounce - Digests: {{noDebounceDigests}}</div>
            <div class="metric">No Debounce - Filter calls: {{noDebounceFilters}}</div>
            <div class="metric">With Debounce - Digests: {{withDebounceDigests}}</div>
            <div class="metric">With Debounce - Filter calls: {{withDebounceFilters}}</div>
            <div class="metric">Reduction: {{reduction}}%</div>
        </div>

        <button ng-click="simulateTyping()">Simulate Rapid Typing</button>
    </div>

    <script>
        angular.module('debounceTest', ['ui.select', 'ngSanitize'])
        .controller('TestController', function($scope, $timeout) {
            // Generate test data
            $scope.items = [];
            for (var i = 0; i < 5000; i++) {
                $scope.items.push({
                    id: i,
                    name: 'Item ' + i,
                    description: 'Description for item ' + i
                });
            }

            $scope.noDebounceDigests = 0;
            $scope.noDebounceFilters = 0;
            $scope.withDebounceDigests = 0;
            $scope.withDebounceFilters = 0;
            $scope.reduction = 0;

            // Track digest cycles
            var originalFilter = angular.module('ng').filter('filter');
            angular.module('debounceTest').filter('filter', function() {
                return function(array, expression, comparator, anyPropertyKey) {
                    // Count filter executions
                    if (array === $scope.items) {
                        var selectElement = angular.element(event.target).closest('ui-select');
                        if (selectElement.length) {
                            var debounce = selectElement.attr('search-debounce');
                            if (debounce === '0') {
                                $scope.noDebounceFilters++;
                            } else {
                                $scope.withDebounceFilters++;
                            }
                        }
                    }
                    return originalFilter.$get[0]()(array, expression, comparator, anyPropertyKey);
                };
            });

            $scope.simulateTyping = function() {
                $scope.noDebounceDigests = 0;
                $scope.noDebounceFilters = 0;
                $scope.withDebounceDigests = 0;
                $scope.withDebounceFilters = 0;

                var selects = document.querySelectorAll('ui-select');
                var select1 = angular.element(selects[0]).controller('uiSelect');
                var select2 = angular.element(selects[1]).controller('uiSelect');

                // Open both
                select1.activate();
                select2.activate();
                $scope.$digest();

                // Track digests during typing
                var unwatchNoDebounce = $scope.$watch(function() {
                    if (select1.open) $scope.noDebounceDigests++;
                });

                var unwatchWithDebounce = $scope.$watch(function() {
                    if (select2.open) $scope.withDebounceDigests++;
                });

                // Simulate rapid typing
                var searchTerms = ['I', 'It', 'Ite', 'Item', 'Item ', 'Item 1', 'Item 10'];
                var index = 0;

                function typeNext() {
                    if (index < searchTerms.length) {
                        select1.search = searchTerms[index];
                        select2.search = searchTerms[index];
                        $scope.$digest();
                        index++;
                        setTimeout(typeNext, 50); // Type every 50ms (faster than debounce)
                    } else {
                        // Wait for debounce to settle
                        setTimeout(function() {
                            unwatchNoDebounce();
                            unwatchWithDebounce();

                            // Calculate reduction
                            $scope.reduction = Math.round((1 - $scope.withDebounceFilters / $scope.noDebounceFilters) * 100);
                            $scope.$digest();

                            console.log('Results:', {
                                noDebounce: {
                                    digests: $scope.noDebounceDigests,
                                    filters: $scope.noDebounceFilters
                                },
                                withDebounce: {
                                    digests: $scope.withDebounceDigests,
                                    filters: $scope.withDebounceFilters
                                },
                                reduction: $scope.reduction + '%'
                            });
                        }, 300);
                    }
                }

                typeNext();
            };
        });
    </script>
</body>
</html>